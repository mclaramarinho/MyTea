@using MyTeaApp.Models.ViewModels;
@using Microsoft.AspNetCore.Http;
@using MyTeaApp.Data;
@using MyTeaApp.Views.Records
@inject ApplicationDbContext _db;
@inject IHttpContextAccessor _httpContextAccessor;
@model RecordVM;

@{
    ViewData["Title"] = "Create Record";

    // int daysInSelectedFortnight = 15;

    var _http = _httpContextAccessor.HttpContext;

    string? urlStartDate = _http.Request.Query["startDate"];

    FortnightData data = new(urlStartDate);
}

@* - IF RECORD NOT NULL SHOW FIELDS FILLED WITH DB DATA *@

<partial name="_AlertMessagePartial"></partial>


@* - SHOW IF EXISTING RECORD IS NULL *@
    <div class="col flex-wrap text-wrap table-responsive">
        <h1>Create Record</h1>

        <h4>Record</h4>
        @* <hr /> *@
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label for="quinzenaSelector">Select Fortnight</label>
                    <select id="quinzenaSelector" class="form-control">
                    @foreach (var quinzena in data.Fortnights)
                        {
                            <option value="@quinzena.Value" selected="@quinzena.Selected">@quinzena.Text</option>
                        }
                    </select>
                </div>
                <form asp-action="Create" method="post" id="registerRecordForm">
                    <div id="records-list" class="">
                        <table id="records-table" class="table">
                            <thead>
                                <tr>
                                    <th class="text-nowrap">Charge Codes</th>
                                @for (int i = 0; i < data.DaysInSelectedFortnight; i++)
                                    {
                                        <th class="date-column text-center"></th>
                                    }
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < 4; i++)
                                {
                                    <tr class="grid">
                                        <td class="g-col-auto">
                                            <div>
                                            <select class="form-select wbsSelector" asp-items="Model.WBS" name="wbs" id="wbsSelector"></select>

                                            </div>
                                        </td>
                                    @for (int j = 0; j < data.DaysInSelectedFortnight; j++)
                                        {

                                        <td class="g-col-1" id="fractionSlot_@((i * data.DaysInSelectedFortnight) + j)">

                                                <input name="hours" type="number"  id="RecordFraction_@(i)_@(j)" value="" min="0" max="24" style="max-width: 40px;" />

                                                <input name="dates" type="hidden" />

                                            </td>
                                        }
                                        <td class="g-col-1">

                                        <input id="rowTotal_@i" type="number" class="row-total" disabled style="max-width: 48px;" />
                                        </td>
                                    </tr>
                                }
                            <input name="email" type="hidden" value="@Model.user" />
                            </tbody>
                            <tfoot>
                                <th>Total</th>
                            @for (int i = 0; i < data.DaysInSelectedFortnight; i++)
                                {
                                    <td class="col-total">
                                        <input id="colTotal_@i" type="number" class="col-total" disabled style="max-width: 40px;" />
                                    </td>
                                }
                                <td class="col-total">
                                    <input type="number" id="result" disabled class="" style="max-width: 48px;" />
                                </td>
                            </tfoot>
                        </table>
                    </div>
                    <input type="submit" value="Create" class="btn btn-primary" id="submitRecord_btn" />
                </form>
            </div>
        </div>

        <div>
            <a asp-action="Index">Back to List</a>
        </div>
    </div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
        await Html.RenderPartialAsync("_CalcInputScriptsPartial");
        await Html.RenderPartialAsync("_IdentifyHolidaysScriptPartial");
        await Html.RenderPartialAsync("_FractionSlotScriptsPartial");
        await Html.RenderPartialAsync("_PopulateWithDbScriptsPartial", Model);
        await Html.RenderPartialAsync("_FormValidationPartial");
        
    }
    <script>
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        document.addEventListener('DOMContentLoaded', async function () {
            let userToView = @(Json.Serialize(ViewData["userSelected"]));
            let shouldSlotsBeEnabled = false;

            // MOD -- added these lines to keep track of the amount of days in fortnight
            const startDate = getFortnightStartDate();
            const daysInFortnight = getDaysInFortnight(startDate);

            await identifyFortnightAndGenerateTable(startDate, daysInFortnight);
            if(@Json.Serialize(Model.ExistingRecord != null)){
                populateTableWithData();
                shouldSlotsBeEnabled = false;
            }else{
                shouldSlotsBeEnabled = true;
            }

            isSlotEnabled(shouldSlotsBeEnabled, daysInFortnight);
            

            /* EVENT LISTENERS */

            const inputElements = document.querySelectorAll('input[id^="RecordFraction"]');

            inputElements.forEach(input => {
                const [base, rowIndex, colIndex] = input.getAttribute('id').split("_");

                input.addEventListener('input', event => handleInput(event, rowIndex, colIndex));
            });

            quinzenaSelector.addEventListener('change', async function () {
                var selectedDate = new Date(this.value).toISOString();
                let newLocation = `/Records/Create?`;
                // let newLocation = `/Records/Create?startDate=${selectedDate}`;
                if (userToView !== null) {
                    newLocation += `uid=${userToView}&startDate=${selectedDate}`;
                } else{
                    newLocation += `startDate=${selectedDate}`;
                }
                window.location.href = newLocation;
            });

            /**
             * description - when no other input (except by holidays) is provided, submitting will update the total hours
             *
             */
            $("#submitRecord_btn").on("mouseup", (e) => {
                inputElements.forEach(input => {
                    const [base, rowIndex, colIndex] = input.getAttribute('id').split("_");
                    handleInput(event, rowIndex, colIndex)
                    document.getElementById("registerRecordForm").onsubmit = (ev) => {
                        validateForm(ev);
                    }
                });
            })


            document.querySelectorAll(".wbsSelector").forEach(i => {
                i.addEventListener("change", e => {
                    isSlotEnabled(shouldSlotsBeEnabled, daysInFortnight);
                })
            })
        });
    </script>
}